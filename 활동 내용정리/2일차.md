# 2일차 진행 내용
# 9/19일 기준 (2일차 수행작업)
 
## 1. 에이전트가 수행해야 할 역할 
	🔍 A. 사용자 정보 기반 추천
	•	성별, 연령대, 건강 증상(예: 피로, 수면장애) 입력
	•	사용 중인 영양제 입력 (중복 성분 체크, 과잉 복용 방지)
	•	건강 목적에 맞는 필수 영양소 우선 추천

    ⚠ B. 섭취 조합 검토
	•	나쁜 조합: 칼슘+철분, 마그네슘+아연(고용량), 철분+커피
	•	좋은 조합: 비타민 C+철분, 오메가-3+비타민 D 등

        🧠 C. 섭취 가이드라인 제공
	•	섭취 시간대별 추천 (아침/점심/저녁)
	•	성분 기준 권장 섭취량 vs. 사용자 실제 섭취량 비교

    💬 D. 리뷰 기반 품질 판단
	•	리뷰 평점/갯수 기반 품질 판단 (ex. 평점 4.8 이상, 리뷰 500+ 우선)
	•	특정 영양소에 대해 효과가 좋다는 리뷰 요약도 가능

## 2. SQL DB 스키마 설계 (PostgreSQL)
좋아 유진, 지금까지 기획안과 데이터 파일(supplement_rag_data_merged_with_reviews.json)을 바탕으로 정리해볼게.

⸻

✅ 1. 에이전트가 수행할 수 있는 주요 역할 (기획안 기반)

기획안에서 확인된 “사용자 맞춤형 영양제 추천 에이전트”의 기능은 다음과 같아:

🔍 A. 사용자 정보 기반 추천
	•	성별, 연령대, 건강 증상(예: 피로, 수면장애) 입력
	•	사용 중인 영양제 입력 (중복 성분 체크, 과잉 복용 방지)
	•	건강 목적에 맞는 필수 영양소 우선 추천

⚠ B. 섭취 조합 검토
	•	나쁜 조합: 칼슘+철분, 마그네슘+아연(고용량), 철분+커피
	•	좋은 조합: 비타민 C+철분, 오메가-3+비타민 D 등

🧠 C. 섭취 가이드라인 제공
	•	섭취 시간대별 추천 (아침/점심/저녁)
	•	성분 기준 권장 섭취량 vs. 사용자 실제 섭취량 비교

💬 D. 리뷰 기반 품질 판단
	•	리뷰 평점/갯수 기반 품질 판단 (ex. 평점 4.8 이상, 리뷰 500+ 우선)
	•	특정 영양소에 대해 효과가 좋다는 리뷰 요약도 가능

⸻

✅ 2. DB 설계 및 구축을 위한 단계 정리

🔨 Step 1. 기초 스키마(DDL) 설계

PostgreSQL로 구축할 테니까, 우선 **DDL 스니펫(스키마 정의 SQL)**을 작성해야 해.
이건 .sql 파일로 저장해서 psql, pgAdmin, 또는 Python에서 실행할 수 있어.

예시 저장 위치:
	•	로컬: ./schema/init_tables.sql
	•	VSCode 프로젝트 폴더 내 db/ 혹은 sql/ 디렉토리 추천

⸻

✅ 3. 추천 DB 테이블 설계안 (DDL 스니펫 포함)

(1) users – 사용자 정보

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    age_group VARCHAR(50),
    gender VARCHAR(10),
    health_issues TEXT[],  -- ["피로", "면역력저하"]
    owned_supplements TEXT[]  -- 사용 중인 영양제 id 리스트
);

(2) nutrients – 필수 영양소 정보

CREATE TABLE nutrients (
    nutrient_id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    daily_rda_male NUMERIC,
    daily_rda_female NUMERIC,
    upper_limit NUMERIC,
    benefits TEXT,
    caution_with TEXT[]  -- ["칼슘", "아연"]
);

(3) products – 영양제 제품 정보

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    title TEXT,
    brand TEXT,
    description TEXT,
    avg_rating NUMERIC,
    reviews_count INTEGER,
    categories TEXT[]
);

(4) product_nutrients – 제품 내 영양소 성분

CREATE TABLE product_nutrients (
    id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(product_id),
    nutrient_name TEXT,
    amount NUMERIC,
    unit VARCHAR(20)
);

(5) reviews – 리뷰 요약 or 원문 (필요시)

CREATE TABLE reviews (
    review_id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(product_id),
    rating NUMERIC,
    review_text TEXT
);

⸻

✅ 4. 전체 구축 작업 순서

1	DDL 파일 작성 및 저장
2	PostgreSQL DB 생성	CREATE DATABASE supplement_ai;
3	테이블 생성	psql 또는 pgAdmin에서 DDL 실행
4	JSON → 테이블 데이터 이관	supplement_rag_data_merged_with_reviews.json 데이터를 파싱하여 products, product_nutrients, reviews에 입력
5	필수 영양소 정보 입력	nutrients 테이블에 PDF 기반 정보 수동 입력 (또는 자동화)
6	테스트용 사용자 정보 입력	users 테이블에 샘플 데이터 입력
7	추천 알고리즘 설계 시작	나이대, 증상별 우선순위 매핑 로직 추가
8	추천 결과 → 챗봇 응답 포맷 설계	LangGraph or LLM과 연결 (추후 진행)





## 실행 체크리스트 
    1.	DB 생성(PostgreSQL) → 위 DDL 실행.
	2.	JSON 스캔 → 성분 사전 시드(동의어 정리).
	3.	RDA 표 적재(연령/성별/단위 일치).
	4.	제품 마스터 적재 → 제품–성분 M:N 적재(정량/단위/ %DV).
	5.	리뷰/집계 적재(랭킹/설명 보강).
	6.	증상–성분 가중치 시드 후 기본 추천 쿼리 테스트.
	7.	품질 점검/인덱스/뷰로 성능·정확도 튜닝.
	8.	LangGraph 연결: DB 쿼리 결과(수치·근거) ↔ RAG로 추천 이유 문장화



# 진행한 것
1. json 파일 2개 통합본 제작
	- 데이터 통합본 하나 만들기 
	<tags 필드 정리>
	•	"nan", "", " " 등 의미 없는 값 제거
	•	중복 제거 + 알파벳 순 정렬
	•	불필요한 특수문자 기반 태그 제거

	<category 필드 정리>
	•	nan, 공백 제거
	•	중복 항목 정리 및 순서 정리

	- supplement_facts 값이 []인 항목을 필터링하여 데이터 품질 관리
	
	- json 파일 92개 성분추출 실패한 것도 포함
	1.	✅ supplement_rag_data_fixed.json — 어제까지 파싱에 성공한 214개 제품 데이터
	2.	✅ supplements_rag_data_final8.json — 오늘 8차 파싱 후 일부 성분추출 실패 데이터를 포함한 보완본
	
2. 리뷰 관련 지표 포함한 json 파일 생성(리뷰 수, 평균 평점)





# 고민한점
1. 성분 추출 못한 92개의 데이터 suppliment_fact가 [] 공란인 데이터를 포함시킬지 고민
	"" 최종적으로  92개 데이터도 활용하되 supliments 공란인 상품은 별도로 분류해서 참고용 혹은 설명기반 추천 후보군으로 활용." 
	- 하는 이유: 리뷰 좋고 인기가 많아서 성분이 자세하진않아도, 해당증상을 가진 사람에게 도움이 될 수 있는 제품을 강력하게 추천하고 싶음. (그러면 리뷰 데이터, 평점 데이터가 있는 경우 유의미함. 혹은 title에 아예 총 용량이 표시된 제품들이 있음(근데 복합적인 성분 함량을 알 수 없어 권장 섭취량 고려하기 힘들 수 있음.))
	- 안하는 이유: 성분을 얼마나 함량했는지에 따라추천을 해줘야하고, 성분에 근거해서 사용자에게 제품을 추천해야하는데 단순히 tag 키워드 중심으로 추천하는 것은 의미가 없다고 판단함. 사용자가 나 ~~~에 좋은 영양제 추천해줘" 라고 했을 때 도움이 될 수 있겠지만..


좋은 질문이에요!
**“사용자 맞춤형 영양제 추천 에이전트”**를 만들 때 성분 추출이 실패한 제품들 (supplement_facts: [])도 포함시킬지 여부는 에이전트의 목적, 추천 전략, 그리고 데이터 활용 방식에 따라 결정됩니다.

⸻

✅ 결론 먼저:

추천 기반이 “성분 중심”이라면 제외하는 것이 좋고, 브랜드/카테고리/텍스트 중심이라면 포함할 가치가 있습니다.

⸻

📌 1. 포함시켰을 때의 장점

항목	설명
브랜드, 카테고리 정보 사용 가능	예: Category 1, Brand, Description, Title 등은 잘 정리돼 있음
텍스트 기반 태깅 또는 유사도 추천 가능	예: “간 건강”, “면역력” 등 키워드가 Description에 있다면 유의미
RAG 에이전트의 컨텍스트 확장	검색 시 Supplement Facts가 없어도 자연어 검색 컨텍스트에 도움 가능
후속 개선 여지	성분 정보가 없는 상태에서도 사용자 질문 ↔ 제품 설명 기반 유사도 계산 가능

➡️ 예:

“면역력을 강화하고 싶어요” → description에 "immune support"가 있는 제품 추천 가능

⸻

❌ 포함시켰을 때의 단점

항목	설명
정확한 성분 기반 매칭 불가	"비타민 C가 500mg 이상" 등 조건부 추천 불가능
LLM 기반 reasoning이 약해짐	"이 제품에는 L-테아닌이 들어 있어요" 같은 정확한 설명이 안됨
추천 품질 저하 가능성	성분 기반 RAG/LLM이 주력일 경우, 보장된 설명 불가

➡️ 예:

“피로 개선에 좋은 마그네슘 제품 추천해줘” → 성분이 없으므로 누락됨

⸻

📊 추천 전략별 활용 여부 정리

추천 전략	supplement_facts 없는 제품 포함 여부
성분 기반 추천 (rule-based)	❌ 제외 추천
자연어 기반 검색 (RAG, LangChain 등)	✅ 포함 가능
유사도 기반 추천 (embedding, 태그 등)	✅ 포함 가능
LLM 응답 기반 추천 (GPT + context)	⚠️ 성분이 없다면 약한 설명만 가능
SQL 필터 추천 (조건 검색)	❌ 성분 없는 데이터 제외 필요


⸻

🧠 전략 제안

✨ 성분이 없는 제품은 별도로 분류하여 “참고용” 또는 **“설명 기반 추천 후보군”**으로 활용하세요.
	•	supplement_facts: [] → "성분 정보 없음"이라는 필드를 명시
	•	description, category, brand 등을 기반으로 유사한 제품 보완 추천

{
  "title": "NOW Foods, Elderberry, 500 mg, 120 Veg Capsules",
  "brand": "NOW Foods",
  "category": ["Elderberry Sambucus", "Common Cold & Flu"],
  "supplement_facts": [],
  "description": "Elderberry (Sambucus nigra) is a multipurpose fruit used widely...",
  "tags": ["Elderberry", "Cold", "Immune"]
}


⸻

✅ 추천 최종 전략
	•	두 데이터셋은 통합 유지하되, supplement_facts가 []인 경우를 필터링해서:
	•	성분 필터링 추천에서는 제외
	•	텍스트 기반 검색이나 유사도 기반에서는 포함

⸻

원하시면:
	•	supplement_facts == []인 제품에 "성분 정보 없음" 태그 추가
	•	별도 추천 로직 구성 (예: fallback candidate 추천)
	•	parsed_data is null인 항목 SQL 구축용 자동 태그 생성

모두 도와드릴 수 있어요.
에이전트 설계 흐름 또는 코드로 구현하길 원하면 말씀해주세요!


#### 통합 시 진행할 수 있는 것 
 완벽한 질문이에요, 그리고 정확히 그 방식이 가능합니다!
LangGraph와 RAG(검색 기반 응답) 구조에서는 사용자 질문 방식에 따라 성분 기반 추천 ↔ 자연어 기반 추천을 자동 전환하거나 조건부 흐름 분기하는 것이 매우 유용합니다.

⸻

✅ 요약: 질문 방식에 따라 데이터 활용을 다르게 하기

사용자 질문 유형	사용 데이터셋 범위	추천 방식
"비타민 C가 500mg 이상인 제품 추천"	supplement_facts가 존재하는 제품만	정량 조건 기반 SQL / 필터
"감기에 좋은 제품 뭐가 있을까?"	supplement_facts가 없어도 포함 (description, category, tags 사용)	자연어 RAG


⸻

🎯 구현 전략 (LangGraph + RAG 기준)

1. 사용자 질문 Intent 분석

LangGraph에서는 이런 식으로 노드 또는 조건문을 분기할 수 있어요:

if is_structured_question(user_input):
    -> route_to_structured_pipeline()  # 성분 기반 RAG / SQL / 필터
else:
    -> route_to_semantic_pipeline()    # 자연어 기반 RAG

is_structured_question()은 “mg”, “IU”, “이상”, “이하”, “포함” 같은 키워드 기반으로 간단하게 구현 가능

⸻

2. 데이터셋 통합 예시 (이미 당신이 갖고 있는 두 JSON)

with open("parsed_success.json", "r", encoding="utf-8") as f1, open("final8_failed_parsed.json", "r", encoding="utf-8") as f2:
    data_success = json.load(f1)
    data_fallback = json.load(f2)

# 통합
full_dataset = data_success + data_fallback

# RAG embedding 대상 선택
structured_data = [d for d in full_dataset if d.get("supplement_facts")]
semantic_data = full_dataset  # 전체 포함 (성분 없는 것도 포함)


⸻

3. LangGraph에서 흐름 제어 예시
	•	📍 Input → Classifier → StructuredRAG or FallbackRAG → Output
	•	사용자의 질문이 "영양소 필터"를 포함하면 → StructuredRAG
	•	아니면 → FallbackRAG (자연어 유사도 + tags + description)

⸻

📚 예시: 질문 분기 흐름

사용자 질문	분기 결과	이유
"마그네슘 200mg 이상"	✅ StructuredRAG	숫자+단위 있음
"숙면에 도움 되는 제품?"	✅ SemanticRAG	의미 기반 키워드 분석
"비타민 C 많이 들어간 제품"	✅ StructuredRAG	"많이" 같은 정량 추정 기반


⸻

✅ 추천

두 JSON 파일을 통합하되, supplement_facts == []인 제품은 fallback 용으로만 활용하고
사용자 질문에 따라 적절한 흐름을 분기해주는 LangGraph 기반 구조를 설계하면:
	•	정확도 높은 성분 추천과
	•	유연한 자연어 검색

을 동시에 구현할 수 있어요.

⸻

🔜 다음 단계 도와줄 수 있어요:
	1.	✅ 두 JSON 파일 통합 코드 (이미 했음)
	2.	✅ 질문 intent 분석기 만들기 (mg, IU, ~이상, ~이하 등)
	3.	✅ LangGraph 흐름 설계
	4.	✅ RAG 문서 embedding 시 fallback 태그 구성

필요하신 방향 말해주시면 바로 코드로 도와드릴게요! 😎